name: Build and Release Xidi KOEI

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch: # 允许手动触发

permissions:
  contents: write # 需要写入权限来创建 Release

jobs:
  build:
    name: Build Xidi (Windows)
    runs-on: windows-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: recursive # 确保拉取子模块（如果 Xidi 有依赖）

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2

    - name: Restore NuGet Packages
      run: nuget restore Xidi.sln

    # 构建 x86 (Win32) 版本
    - name: Build x86 (Release)
      run: msbuild Xidi.sln /p:Configuration=Release /p:Platform=Win32 /p:OutDir=Output\Release\Win32\

    - name: Build x64 (Release)
      run: msbuild Xidi.sln /p:Configuration=Release /p:Platform=x64 /p:OutDir=Output\Release\x64\

    # 打包制品
    - name: Package Artifacts
      shell: pwsh
      run: |
        # 设置遇到错误立即停止，防止静默失败
        $ErrorActionPreference = 'Stop'
        
        # 屏蔽 New-Item 的默认输出
        New-Item -ItemType Directory -Force -Path artifacts/x86 | Out-Null
        New-Item -ItemType Directory -Force -Path artifacts/x64 | Out-Null
        
        # 调试：打印所有生成的 DLL 文件路径
        Write-Host "--- Debug: Found DLLs ---"
        Get-ChildItem -Path "Output" -Recurse -Filter "*.dll" | Select-Object FullName
        Write-Host "-------------------------"

        $x86Path = ".\Output\Release\Win32\*.dll"
        $x64Path = ".\Output\Release\x64\*.dll"

        Write-Host "Copying x86 files..."
        Copy-Item -Path $x86Path -Destination "artifacts\x86"
        
        Write-Host "Copying x64 files..."
        Copy-Item -Path $x64Path -Destination "artifacts\x64"
        
        # 严谨检查：确保文件被成功复制，否则报错终止
        if (-not (Test-Path "artifacts\x86\*.dll")) { throw "Error: No x86 DLLs found in artifacts\x86!" }
        if (-not (Test-Path "artifacts\x64\*.dll")) { throw "Error: No x64 DLLs found in artifacts\x64!" }

        Write-Host "Compressing files..."
        Compress-Archive -Path "artifacts\x86\*" -DestinationPath "Xidi-x86.zip" -Force
        Compress-Archive -Path "artifacts\x64\*" -DestinationPath "Xidi-x64.zip" -Force
        Write-Host "Compression finished."
        cd Output/Release
        7z a Xidi-x86.zip Win32/*
        7z a Xidi-x64.zip x64/*

    # 增加保留 Artifacts 步骤，方便你在 GitHub 网页端直接下载解压前的原始文件排查问题
    - name: Upload Raw Artifacts for Debugging
      uses: actions/upload-artifact@v4
      with:
        name: Xidi-Raw-Artifacts
        path: artifacts/

    # 生成 Epoch 时间戳
    - name: Generate Epoch Tag
      id: tag
      shell: pwsh
      run: |
        $epoch = [int][double]::Parse((Get-Date -UFormat %s))
        echo "TAG_NAME=$epoch" >> $env:GITHUB_ENV
        Write-Host "Generated Tag: $epoch"

    # 创建 Release 并上传 (仅在 push 到主分支时触发，避免 PR 触发发布)
    - name: Create Epoch Release
      # 修改处：允许 'workflow_dispatch' (手动触发) 也能执行发布
      # 同时也移除了对 master 分支的强行检查，方便你在其他分支测试
      if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.TAG_NAME }}
        name: Release ${{ env.TAG_NAME }}
        draft: false
        prerelease: false
        files: |
          Xidi-x86.zip
          Xidi-x64.zip
          Output/Release/Xidi-x86.zip
          Output/Release/Xidi-x64.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
